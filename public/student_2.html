<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    /*  CSS 反轉(鏡面) */
    #myVideo,
    #remoteVideo {
      transform: scaleX(-1);
    }
  </style>
</head>

<body>
  <div>
    <p>available student number: 12, 45, 699, 38, 40, 2998, 1, 99, 200, 1000</p>
    <label for="student-number"></label>學生編號
    <input type="number" name="student-number" id="student-number">
    <button class="conn">建立連線</button>
    <br>
    <br>
    <p id="after-conn"></p>
    <video width="500" height="500" autoplay id="remoteVideo" muted playsinline style="border: 1px solid red"></video>
  </div>


  <!-- socket io 套件 -->
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"
    integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k"
    crossorigin="anonymous"></script>

  <!-- 自己寫的腳本 -->
  <script>
    const socket = io()

    const roomId = 999
    let studentId

    const studentNumber = document.querySelector('#student-number')
    const connBtn = document.querySelector('.conn')
    const remoteVideo = document.querySelector('#remoteVideo')
    const afterConn = document.querySelector('#after-conn')

    let pc
    let sdp

    connBtn.addEventListener('click', () => {
      if (!studentNumber.value) {
        return alert('請輸入學生編號')
      }

      studentId = +studentNumber.value
      afterConn.innerText = `學生編號 ${studentId} 已加入 room ${roomId}`
      initPeer()
      joinRoom()

      // 監聽 peerConnectSignaling ，再判斷收到結果是 SDP 還是 ICE 候選位置
      socket.on(roomId, async (message) => {
        // desc 指的是 SDP 的 Offer 與 Answer。currentRemoteDescription 代表的是最近一次連線成功的相關訊息
        if (message.desc && message.studentId === studentId) { // 如果是 SDP
          // console.log('desc => ', message.desc)

          await pc.setRemoteDescription(new RTCSessionDescription(message.desc)) // 呼叫 setRemoteDescription 儲存收到的 SDP
          createSDP('Answer')
        } else if (message.candidate && +message.studentId === studentId) { // 如果收到的是 ICE 候選位置
          // console.log('candidate =>', message.candidate)
          pc.addIceCandidate(new RTCIceCandidate(message.candidate)) // 儲存收到的 ice candidate
        }
      })

      onIceCandidates()
      // onIceconnectionStateChange()
      onAddStream()
    })


    // 建立 P2P 連接（電腦大多位於 NAT 之後，因此使用 STUN 技術，向 STUN server 取得候選 ip）
    function initPeer() {
      const configuration = {
        iceServers: [{
          urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
        }]
      }
      pc = new RTCPeerConnection(configuration) // 建立一個 peer connection instance
    }

    // 加入房間
    function joinRoom() {
      // 使用 socket io 向 server 發送訊號
      socket.emit('joinRoom', {
        roomId,
        studentId,
        joinRoom: 'new member join'
      });
    }


    async function createSDP(type) {
      // pc.createOffer 或 pc.createAnswer 需要的基本參數
      const signalOption = {
        offerToReceiveAudio: 1, // 是否傳送聲音流給對方
        offerToReceiveVideo: 1, // 是否傳送影像流給對方
      }

      try {
        if (!pc) {
          return alert('尚未開啟視訊')
        }

        const createType = type === 'Offer' ? 'createOffer' : 'createAnswer' // 決定要建立 Offer 還是 Answer
        const sdp = await pc[createType](signalOption) // 建立 SDP
        await pc.setLocalDescription(sdp) // 建立好的 SDP 交給 pc instance 存在 local description。同時，pc 開始去 get candidates（接著將觸發 onIceCandidates
        // 把 sdp 傳給 Signaling Sever
        socket.emit("peerConnectSignaling", {
          roomId,
          studentId,
          desc: pc.localDescription
        })
      } catch (err) {
        console.log(err)
      }
    }


    // 監聽 onicecandidate 狀態
    function onIceCandidates() {
      // 如果建立了 ICE candidate，就用 socket.io 送去給 Server
      pc.onicecandidate = ({ candidate }) => {
        if (!candidate) { return }

        // console.log('onIceCandidate => ', candidate)
        socket.emit('peerConnectSignaling', {
          roomId,
          studentId,
          candidate
        })
        // console.log('送出 ice candidate!');
      }
    }

    // // 監聽 ICE 連接狀態變更與否，iceConnectionState 共 7 種，若變更則印出狀態
    // function onIceconnectionStateChange() {
    //   pc.oniceconnectionstatechange = (evt) => {
    //     console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState)
    //   }
    // }

    // 監聽是否有流傳入，如果有的話就顯示影像
    function onAddStream() {
      pc.onaddstream = (event) => {
        if (!remoteVideo.srcObject && event.stream) {
          remoteVideo.srcObject = event.stream
          // console.log(event.stream)
          // console.log('接收流並顯示於遠端視訊！', event)
        }
      }
    }











  </script>
</body>

</html>